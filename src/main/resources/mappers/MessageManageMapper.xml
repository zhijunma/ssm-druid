<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cn.school.mapper.MessageManageMapper">


    <!--获取已读消息-->
    <select id="getReadMessage" resultType="com.cn.school.DTO.GetMessageDTO">

        select
        m.guid as guid,
        m.message as message,
        m.add_visitor as addVisitor,
        m.add_visitor_id as addVisitorId,
        m.add_time as addTime,
        v.qq as qq,
        v.email as email,
        v.wx as wx,
        v.phone as phone
        from message m,visitors v
        where m.delete_flag = 0
        and m.add_visitor_id = v.guid
        and m.state = 1
    </select>

    <!--获取未读消息-->
    <select id="getUnreadMessage" resultType="com.cn.school.DTO.GetMessageDTO">

        select
        m.guid as guid,
        m.message as message,
        m.add_visitor as addVisitor,
        m.add_visitor_id as addVisitorId,
        m.add_time as addTime,
        v.qq as qq,
        v.email as email,
        v.wx as wx,
        v.phone as phone
        from message m,visitors v
        where m.delete_flag = 0
        and m.add_visitor_id = v.guid
        and m.state = 0
    </select>
    <!--getMessageByVisitor-->
    <select id="getUnreadMessageByVisitor" resultType="com.cn.school.DTO.GetMessageDTO">
        select
        m.guid as guid,
        m.message as message,
        m.add_visitor as addVisitor,
        m.add_visitor_id as addVisitorId,
        m.add_time as addTime,
        v.qq as qq,
        v.email as email,
        v.wx as wx,
        v.phone as phone
        from message m,visitors v
        where m.delete_flag = 0
        and m.add_visitor_id = v.guid
        and m.add_visitor_id = #{guid}
        and m.state = 0
    </select>
    <!--getMessageByVisitor-->
    <select id="getReadMessageByVisitor" resultType="com.cn.school.DTO.GetMessageDTO">
        select
        m.guid as guid,
        m.message as message,
        m.add_visitor as addVisitor,
        m.add_visitor_id as addVisitorId,
        m.add_time as addTime,
        v.qq as qq,
        v.email as email,
        v.wx as wx,
        v.phone as phone
        from message m,visitors v
        where m.delete_flag = 0
        and m.add_visitor_id = v.guid
        and m.add_visitor_id = #{guid}
        and m.state = 1
    </select>
    <!--根据添加人ID更新留言状态-->
    <update id="updateStatusByAddVisitorId">
        update message
        set
        state = 1,
        mod_time = #{time}
        where state = 0
        and add_visitor_id = #{id}
    </update>
</mapper>